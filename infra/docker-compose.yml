name: realchat-local

x-common: &common
  restart: unless-stopped
  networks:
    - realchat
  env_file:
    - .env

x-go-service: &go-service
  <<: *common
  build:
    context: ../
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8090/health/live"] # Default for most, will override if needed
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 10s

networks:
  realchat:

services:

  # ================= JAEGER =================
  jaeger:
    <<: *common
    image: jaegertracing/all-in-one:1.53
    container_name: realchat-jaeger
    ports:
      - "16686:16686" # UI
      - "14268:14268" # Collector

  # ================= PROMETHEUS =================
  prometheus:
    <<: *common
    image: prom/prometheus:v2.49.1
    container_name: realchat-prometheus
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  # ================= GRAFANA =================
  grafana:
    <<: *common
    image: grafana/grafana:10.3.1
    container_name: realchat-grafana
    ports:
      - "3000:3000"
    volumes:
      - ./config/grafana/provisioning:/etc/grafana/provisioning

  # ================= POSTGRES =================
  postgres:
    <<: *common
    image: postgres:16
    container_name: realchat-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "5432:5432"

  # ================= REDIS =================
  redis:
    <<: *common
    image: redis:7
    container_name: realchat-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ================= ZOOKEEPER =================
  zookeeper:
    <<: *common
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: realchat-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  # ================= KAFKA =================
  kafka:
    <<: *common
    image: confluentinc/cp-kafka:7.6.0
    container_name: realchat-kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    ports:
      - "29092:29092"

  # ================= KAFKA TOPIC INIT =================
  kafka-init:
    <<: *common
    image: confluentinc/cp-kafka:7.6.0
    container_name: realchat-kafka-init
    depends_on:
      kafka:
        condition: service_started
    entrypoint: [ "bash", "-c" ]
    command: |
      echo "Waiting for Kafka..."
      sleep 10
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic messaging.events.v1 --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic conversation.events.v1 --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic auth.user.created --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic profile.updated --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic contact.added --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic contact.removed --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user.blocked --partitions 1 --replication-factor 1
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic user.unblocked --partitions 1 --replication-factor 1
      echo "Kafka topics ready."
    restart: "no"

  # ================= MIGRATIONS =================
  auth-migrate:
    <<: *common
    image: migrate/migrate
    container_name: realchat-auth-migrate
    depends_on:
      postgres:
        condition: service_healthy
    command: [ "-path", "/migrations", "-database", "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/auth?sslmode=disable", "up" ]
    volumes:
      - ../services/auth/migrations:/migrations
    restart: "no"

  profile-migrate:
    <<: *common
    image: migrate/migrate
    container_name: realchat-profile-migrate
    depends_on:
      postgres:
        condition: service_healthy
    command: [ "-path", "/migrations", "-database", "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/profile?sslmode=disable", "up" ]
    volumes:
      - ../services/profile/migrations:/migrations
    restart: "no"

  message-migrate:
    <<: *common
    image: migrate/migrate
    container_name: realchat-message-migrate
    depends_on:
      postgres:
        condition: service_healthy
    command: [ "-path", "/migrations", "-database", "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/messaging?sslmode=disable", "up" ]
    volumes:
      - ../services/message/migrations:/migrations
    restart: "no"

  conversation-migrate:
    <<: *common
    image: migrate/migrate
    container_name: realchat-conversation-migrate
    depends_on:
      postgres:
        condition: service_healthy
    command: [ "-path", "/migrations", "-database", "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/conversation?sslmode=disable", "up" ]
    volumes:
      - ../services/conversation/migrations:/migrations
    restart: "no"

  # ================= AUTH SERVICE =================
  auth:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/auth/Dockerfile
    container_name: realchat-auth
    depends_on:
      auth-migrate:
        condition: service_completed_successfully
      kafka-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/auth?sslmode=disable
      HTTP_ADDR: ":8081"
      GRPC_ADDR: ":50051"
      SERVICE_NAME: auth-service
      OBS_HTTP_ADDR: ":8091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health/live"]
    ports:
      - "8081:8081"
      - "50051:50051"
      - "8091:8091"

  # ================= PROFILE SERVICE =================
  profile:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/profile/Dockerfile
    container_name: realchat-profile
    depends_on:
      profile-migrate:
        condition: service_completed_successfully
      kafka-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/profile?sslmode=disable
      HTTP_PORT: "8082"
      GRPC_ADDR: ":50052"
      SERVICE_NAME: profile-service
      HTTP_ADDR: ":8092"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/health/live"]
    ports:
      - "8082:8082"
      - "50052:50052"
      - "8092:8092"

  # ================= MESSAGING SERVICE =================
  messaging:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/message/Dockerfile
    container_name: realchat-messaging
    depends_on:
      message-migrate:
        condition: service_completed_successfully
      kafka-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/messaging?sslmode=disable
      GRPC_ADDR: ":50053"
      KAFKA_TOPIC: messaging.events.v1
      SERVICE_NAME: messaging-service
      HTTP_ADDR: ":8094"
      CONVERSATION_SVC_ADDR: conversation:50055
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/health/live"]
    ports:
      - "50053:50053"
      - "8094:8094"

  # ================= CONVERSATION SERVICE =================
  conversation:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/conversation/Dockerfile
    container_name: realchat-conversation
    depends_on:
      conversation-migrate:
        condition: service_completed_successfully
      kafka-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/conversation?sslmode=disable
      GRPC_ADDR: ":50055"
      KAFKA_TOPIC: conversation.events.v1
      SERVICE_NAME: conversation-service
      HTTP_ADDR: ":8095"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/health/live"]
    ports:
      - "50055:50055"
      - "8095:8095"

  # ================= DELIVERY SERVICE =================
  delivery:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/delivery/Dockerfile
    container_name: realchat-delivery
    depends_on:
      kafka:
        condition: service_started
      redis:
        condition: service_started
      messaging:
        condition: service_started
      conversation:
        condition: service_started
      presence:
        condition: service_started
    environment:
      HTTP_PORT: ":8083"
      KAFKA_TOPICS: messaging.events.v1,conversation.events.v1
      MSG_SVC_ADDR: messaging:50053
      CONV_SVC_ADDR: conversation:50055
      PRESENCE_SVC_ADDR: presence:50056
      INSTANCE_ID: delivery-1
      SERVICE_NAME: delivery-service
      HTTP_ADDR: ":8093"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8093/health/live"]
    ports:
      - "8083:8083"
      - "8093:8093"

  # ================= PRESENCE SERVICE =================
  presence:
    <<: *go-service
    build:
      context: ../
      dockerfile: services/presence/Dockerfile
    container_name: realchat-presence
    depends_on:
      redis:
        condition: service_started
    environment:
      GRPC_ADDR: ":50056"
      INSTANCE_ID: presence-1
      SERVICE_NAME: presence-service
      HTTP_ADDR: ":8096"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health/live"]
    ports:
      - "50056:50056"
      - "8096:8096"

  # ================= API GATEWAY =================
  gateway:
    <<: *go-service
    build:
      context: ../
      dockerfile: edge/gateway/Dockerfile
    container_name: realchat-gateway
    depends_on:
      auth:
        condition: service_started
      profile:
        condition: service_started
      messaging:
        condition: service_started
      conversation:
        condition: service_started
      delivery:
        condition: service_started
      presence:
        condition: service_started
    environment:
      PORT: "8080"
      AUTH_GRPC_ADDR: auth:50051
      PROFILE_GRPC_ADDR: profile:50052
      MSG_GRPC_ADDR: messaging:50053
      CONV_GRPC_ADDR: conversation:50055
      PRESENCE_GRPC_ADDR: presence:50056
      SERVICE_NAME: gateway
      HTTP_ADDR: ":8090"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health/live"]
    ports:
      - "8080:8080"
      - "8090:8090"

  # ================= NGINX (WebSocket Entry) =================
  nginx:
    <<: *common
    image: nginx:alpine
    container_name: realchat-nginx
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - delivery
